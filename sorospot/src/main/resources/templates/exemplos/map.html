<div th:fragment="content">
  <h2>Mapa de Sorocaba - SP</h2>
  <div>
    <input id="address" placeholder="Pesquisar endereço" style="width: 60%" />
    <button id="searchBtn">Buscar</button>
  </div>
  <div id="map" style="width: 100%; height: 500px; margin-top: 8px"></div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const googleMapsApiKey = /*[[${googleMapsApiKey}]]*/ "";
    /*]]>*/
  </script>

  <script
    th:src="|https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initMap|"
    async
    defer
  ></script>

  <script>
    let map;
    let markers = [];

    function initMap() {
      const sorocaba = { lat: -23.5015, lng: -47.4526 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: sorocaba,
      });

      // carregar marcadores existentes (DB-backed occurrences)
      fetch("/api/maps/occurrences")
        .then((r) => r.json())
        .then((list) => {
          list.forEach((o) => {
            let lat = null,
              lng = null;
            if (o.address && o.address.startsWith("lat:")) {
              const parts = o.address.split(",");
              lat = parseFloat(parts[0].split(":")[1]);
              lng = parseFloat(parts[1].split(":")[1]);
            }
            if (lat && lng)
              addMarkerToMap({
                id: o.id,
                title: o.description || o.category,
                description: "",
                lat,
                lng,
              });
          });
        });

      map.addListener("click", (e) => {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();

        const add = confirm("Deseja adicionar uma ocorrência neste local?");
        if (!add) return;
        const title = prompt("Título da ocorrência (ex: Buraco, Acidente):");
        if (!title) return;
        const description = prompt("Descrição (opcional):");
        const payload = { title, description, lat, lng };
        fetch("/api/maps/markers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((r) => r.json())
          .then((m) => {
            let latResp = null,
              lngResp = null;
            if (m.address && m.address.startsWith("lat:")) {
              const parts = m.address.split(",");
              latResp = parseFloat(parts[0].split(":")[1]);
              lngResp = parseFloat(parts[1].split(":")[1]);
            }
            if (latResp && lngResp)
              addMarkerToMap({
                id: m.id,
                title: m.title || m.description,
                description: m.description || "",
                lat: latResp,
                lng: lngResp,
              });
          });
      });

      document.getElementById("searchBtn").addEventListener("click", () => {
        const q = document.getElementById("address").value;
        if (!q) return;
        fetch("/api/maps/geocode-simple?address=" + encodeURIComponent(q))
          .then((r) => r.json())
          .then((result) => {
            if (!result || !result.formattedAddress) {
              alert("Nenhum resultado.");
              return;
            }
            const pos = { lat: result.lat, lng: result.lng };
            map.setCenter(pos);
            map.setZoom(16);
            addMarkerToMap({
              id: null,
              title: result.formattedAddress,
              description: "",
              lat: result.lat,
              lng: result.lng,
            });
          })
          .catch((e) => alert("Erro ao buscar: " + e));
      });
    }

    function addMarkerToMap(m) {
      const gMarker = new google.maps.Marker({
        position: { lat: m.lat, lng: m.lng },
        map: map,
        title: m.title,
      });
      const infow = new google.maps.InfoWindow({
        content: `<strong>${escapeHtml(m.title)}</strong><div>${escapeHtml(
          m.description || ""
        )}</div>`,
      });
      gMarker.addListener("click", () => infow.open(map, gMarker));
      markers.push(gMarker);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>\"']/g, function (s) {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[s];
      });
    }
  </script>
</div>
